<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Kanit', sans-serif;
    margin: 20px;
    background: #f9fbfd;
    color: #222;
  }
  h2 {
    text-align: center;
    color: #0b63b8;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    font-size: 14px;
    text-align: center;
  }
  th {
    background: #eaf6ff;
    color: #0b2540;
  }
  tr:nth-child(even) {
    background: #f9fcff;
  }
  button.return-btn {
    background: #1e90ff;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
  }
  button.return-btn:hover {
    background: #0b63b8;
  }
  .status-returned {
    color: green;
    font-weight: bold;
  }
  .status-borrowed {
    color: #d97706;
    font-weight: bold;
  }

  /* üîπ SweetAlert2 custom style */
  .swal2-popup {
    font-family: 'Kanit', sans-serif !important;
    border-radius: 12px !important;
    padding: 25px !important;
  }
  .swal2-title {
    font-size: 22px !important;
    color: #0b63b8 !important;
  }
  .swal2-content {
    font-size: 16px !important;
    color: #333 !important;
  }
  .swal2-confirm {
    background-color: #1e90ff !important;
    color: white !important;
    font-weight: 600 !important;
    border-radius: 8px !important;
    padding: 8px 20px !important;
    margin: 0 10px !important;
  }
  .swal2-cancel {
    background-color: #d33 !important;
    color: white !important;
    font-weight: 600 !important;
    border-radius: 8px !important;
    padding: 8px 20px !important;
    margin: 0 10px !important;
  }
  .swal2-icon {
    width: 60px !important;
    height: 60px !important;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h2>
<table>
  <thead>
    <tr>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
      <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
      <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbxqoYM9RRnezVssaYsoMa_MEf2Ptd67hOGzgWpduknp9P8BfTy-B0ROjZl0AFoWYGx_CA/exec';
const params = new URLSearchParams(window.location.search);
const fullname = params.get('fullname') || localStorage.getItem('fullname');
const phone = params.get('phone') || localStorage.getItem('phone');

async function loadHistory() {
  if (!fullname || !phone) return;
  try {
    const res = await fetch(`${scriptURL}?fullname=${encodeURIComponent(fullname)}&phone=${encodeURIComponent(phone)}`);
    const data = await res.json();
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      const status = row.status === '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 
        `<span class="status-returned">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>` : 
        `<span class="status-borrowed">${row.status}</span>`;

      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏∑‡∏ô"
      const actionBtn = row.status !== '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
        ? `<button class="return-btn" onclick="returnItem('${row.fullname}','${row.phone}','${row.item}', this)">‡∏Ñ‡∏∑‡∏ô</button>`
        : '-';

      tr.innerHTML = `
        <td>${row.timestamp ? new Date(row.timestamp).toLocaleString('th-TH') : ''}</td>
        <td>${row.fullname}</td>
        <td>${row.phone}</td>
        <td>${row.item}</td>
        <td>${row.qty}</td>
        <td>${status}</td>
        <td>${actionBtn}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch(err) {
    console.error(err);
  }
}

// üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô returnItem() ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡πà‡∏á
async function returnItem(fullname, phone, item, btn) {
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item} ?`)) return;
  try {
    const url = `${scriptURL}?action=return&fullname=${encodeURIComponent(fullname)}&phone=${encodeURIComponent(phone)}&item=${encodeURIComponent(item)}`;
    const res = await fetch(url);
    const result = await res.json();
    if (result.result === 'success') {
      const row = btn.closest('tr');
      row.querySelector('td:nth-child(6)').innerHTML = `<span class="status-returned">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>`;
      row.querySelector('td:nth-child(7)').innerHTML = '-';
      alert('‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ'));
    }
  } catch(err) {
    console.error(err);
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
  }
}

window.onload = loadHistory;
</script>
</body>
</html>
